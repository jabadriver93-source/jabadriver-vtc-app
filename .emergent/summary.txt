<analysis>**original_problem_statement:**
L'utilisateur a demandé d'implémenter un ensemble de fonctionnalités complexes pour son application VTC (Jabadriver) concernant la facturation, la modification des courses et la génération de documents.

**PRODUCT REQUIREMENTS:**
1.  **Facturation au nom du chauffeur :** Pour les courses attribuées, les factures et bons de commande (BDC) doivent être émis au nom du chauffeur (raison sociale, adresse, SIRET, mention TVA) et non plus au nom de Jabadriver. Un pied de page légal pour Jabadriver doit être ajouté.
2.  **Numérotation des factures par chauffeur :** Chaque chauffeur doit avoir sa propre séquence de numérotation de factures (ex: ), indépendante de la plateforme.
3.  **Modification de course par le client :** Permettre au client de modifier sa réservation (adresses, date, heure, passagers) via sa page token, avec recalcul automatique du prix, tant que la facture n'est pas émise. Des notifications doivent être envoyées à l'admin et au chauffeur.
4.  **Gestion des suppléments par le chauffeur :** Permettre au chauffeur d'ajouter des suppléments (péage, parking, attente) à une course avant l'émission de la facture.
5.  **Workflow de facturation (Draft/Issued) :** Mettre en place un statut de facture. Seul le chauffeur peut finaliser (émettre) une facture. Une fois émise, la course et la facture deviennent non modifiables.
6.  **Notifications par email :** Envoyer un email au client lorsqu'une course lui est attribuée, avec les détails du chauffeur.
7.  **Champs chauffeur obligatoires :** Rendre les informations légales du chauffeur (raison sociale, adresse, SIRET, mention TVA) obligatoires à l'inscription.
8.  **Filtre pour les courses de test :** (Dernière demande) Ajouter un booléen  sur les courses pour les exclure des statistiques de revenus et de commissions, avec un bouton de basculement dans l'interface d'administration.

**User's preferred language**: Français

**what currently exists?**
Une application VTC full-stack (React/FastAPI/MongoDB) avec gestion des réservations, des chauffeurs et des commissions (Stripe). Le système vient d'être massivement mis à jour pour inclure un système de facturation complet au nom du chauffeur, avec des numéros de facture séquentiels par chauffeur, un statut /, la gestion des suppléments par le chauffeur, et la modification des courses en libre-service par le client. Toutes ces fonctionnalités ont été implémentées et testées avec succès, y compris les modifications du frontend pour les portails chauffeur et client.

**Last working item**:
    - Last item agent was working: Implémentation d'un filtre pour les courses de test. L'agent s'apprêtait à démarrer le développement de la fonctionnalité  demandée par l'utilisateur.
    - Status: NOT STARTED
    - Agent Testing Done: N
    - Which testing method agent to use? both. L'agent devra :
        1.  Modifier le modèle backend () et les routes de statistiques pour exclure les courses .
        2.  Ajouter un bouton de basculement dans l'interface d'administration (React).
        3.  Utiliser l'agent de test backend pour vérifier que les calculs ignorent bien les courses de test.
        4.  Utiliser l'agent de test frontend pour valider le fonctionnement du bouton dans l'interface admin.
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: Implémenter le filtre pour les courses de test (P0 - HIGHEST)

  Issues Detail:
  - Issue 1: 
     - **Description:** Ajouter un champ booléen  aux courses. Les courses marquées comme test ne doivent pas être incluses dans les tableaux de bord, les statistiques de revenus et les calculs de commission. Un bouton doit être ajouté dans l'interface d'administration pour marquer/démarquer une course comme test.
     - **Attempted fixes:** Aucun, la tâche vient d'être demandée.
     - **Next debug checklist:**
       1.  Modifier le modèle Pydantic  dans  pour ajouter .
       2.  Créer une nouvelle route API (ex: ) pour basculer la valeur de .
       3.  Modifier toutes les routes de calcul de statistiques et de commissions pour filtrer les courses avec .
       4.  Dans l'interface d'administration React, ajouter un bouton sur chaque ligne de course pour appeler la nouvelle API.
       5.  Vérifier qu'aucune donnée existante n'est supprimée et que la numérotation des factures n'est pas affectée.
     - **Why fix this issue and what will be achieved with the fix?** Permettre à l'administrateur de créer des courses de test sans fausser les statistiques financières de la plateforme.
     - **Status:** NOT STARTED
     - **Is recurring issue?** N
     - **Should Test frontend/backend/both after fix?** both
     - **Blocked on other issue:** None

**In progress Task List**:
- Aucune.

**Upcoming and Future Tasks**
    **Upcoming Tasks:**
    - **P1: Dashboard statistiques admin:** Créer un tableau de bord avec des statistiques pour l'administrateur. Cette tâche est directement liée à l'implémentation du flag .
    
    **Future Tasks:**
    - Notifications push pour les chauffeurs.
    - Chat en temps réel.
    - Améliorations du dashboard statistiques.

**Completed work in this session**
- **Refonte Complète du Système de Facturation:**
  - **Modèles de Données :** Ajout des champs , , , ,  au modèle . Ajout de , , ,  au modèle .
  - **Facturation Chauffeur :** La génération de PDF pour les BDC et factures a été modifiée pour utiliser les informations du chauffeur comme émetteur et inclure un pied de page légal Jabadriver.
  - **Numérotation Indépendante :** Implémentation d'une logique pour générer un  unique à l'inscription et une séquence de factures par chauffeur ().
  - **Workflow DRAFT/ISSUED :** Mise en place d'un flux où le chauffeur peut ajouter des suppléments (péage, parking, attente) tant que la facture est en , puis l'émettre pour la rendre immuable ().
- **Modification de Course par le Client :**
  - Le portail client () a été entièrement reconstruit pour permettre la modification directe des détails de la course avec recalcul automatique du prix. La modification est bloquée une fois la facture émise.
- **Mise à jour des Interfaces :**
  - L'espace chauffeur () a été refait pour intégrer la gestion des suppléments et l'émission des factures.
  - Le formulaire d'inscription chauffeur () a été mis à jour avec les nouveaux champs obligatoires.
- **Backend :** Ajout de multiples endpoints dans  pour gérer les nouvelles fonctionnalités (, , , ).
- **Tests :** L'ensemble des nouvelles fonctionnalités a été validé avec succès par  (rapport disponible), confirmant l'absence de régressions sur les systèmes existants (Stripe, claim, commissions).

**Earlier issues found/mentioned but not fixed**
   - **Issue 1: Incohérence des icônes PWA.** L'icône de la PWA chauffeur est incorrecte sur la page  en production. Cette tâche a été mise en attente car l'utilisateur a priorisé une refonte majeure des fonctionnalités de facturation. L'utilisateur n'a pas mentionné ce problème à nouveau durant la session.

**Known issue recurrence from previous fork**
  - La gestion des assets PWA a été un problème récurrent dans les forks précédents, nécessitant plusieurs ajustements pour atteindre la parité entre la prévisualisation et la production.

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Pydantic (validation des modèles), Motor (MongoDB driver), ReportLab (génération PDF).
- **Frontend:** React, TailwindCSS, Shadcn UI, hooks (, ) pour la gestion d'état et les appels API.
- **Architecture:** API RESTful, application monopage (SPA).

**key DB schema**
- ** collection:**
  - : string
  - : string
  - : string
  - : string
  - : string (ex: DR01)
- ** collection:**
  - : string (DRAFT ou ISSUED)
  - : string (ex: DR01-2026-001)
  - : datetime
  - : dict { : float, : float, : float }
  - : boolean (à ajouter)

**changes in tech stack**
- Aucune.

**All files of reference**
- : Fichier principal du backend, contient la logique pour la plupart des nouvelles fonctionnalités.
- : Interface de modification de course pour le client.
- : Interface de gestion des courses/factures pour le chauffeur.
- : Formulaire d'inscription du chauffeur.
- : Contient les exigences produit à jour.
- : Rapport de test validant la dernière session de développement.

**Areas that need refactoring**:
- Le fichier  est devenu très volumineux et complexe. Il devrait être découpé en plusieurs routeurs (fichiers) par domaine fonctionnel (ex: , , , ) pour améliorer la maintenabilité.
- La logique de basculement de manifeste PWA, mentionnée dans le fork précédent, pourrait être extraite dans un hook React personnalisé () pour éviter la duplication de code.

**key api endpoints**
- : Modifie une course existante.
- : Ajoute des suppléments à une course.
- : Finalise et émet une facture.
- : Calcule le prix d'un itinéraire.
- : (À créer) Bascule le statut de test d'une course.

**Critical Info for New Agent**
- **Priorité Absolue :** La nouvelle tâche consiste à implémenter le flag . Cette modification touche aux calculs financiers, il est donc impératif de ne créer **aucune régression** sur le système de facturation, de commissionnement Stripe, ou de génération de PDF qui vient d'être validé.
- **Tests Rigoureux :** L'utilisateur a explicitement demandé de ne rien casser. Après avoir implémenté la fonctionnalité , des tests de non-régression complets sont nécessaires.
- **Base de Code Stable :** Vous partez d'une base de code stable et entièrement testée pour le périmètre fonctionnel précédent. Le rapport de test  le confirme.
- **Problème en Attente :** Le problème d'icône PWA du fork précédent est toujours non résolu mais de priorité basse. Ne l'adressez pas sauf si l'utilisateur le demande explicitement.

**documents and test reports created in this job**
- 
- 

**Last 10 User Messages and any pending HUMAN messages** 
10. **(user):** Demande de mettre en place un système pour marquer des courses comme test afin de les exclure des statistiques, sans supprimer de données ni réinitialiser les compteurs.
9.  **(agent):** Confirme la fin de l'implémentation et la mise à jour du PRD.
8.  **(agent):** Note que la validation des champs vides fonctionne et que le rapport du testing agent était un faux positif sur ce point.
7.  **(agent):** Annonce que le testing agent a validé toutes les fonctionnalités à 100% et qu'il va corriger une recommandation mineure.
6.  **(agent):** Appelle le  pour une validation complète.
5.  **(agent):** Confirme via une capture d'écran que l'interface chauffeur se met à jour correctement après l'émission de la facture (boutons désactivés, badge mis à jour).
4.  **(agent):** Confirme via une capture d'écran que la page client bloque bien les modifications après l'émission de la facture.
3.  **(agent):** Confirme que la facture a bien été émise avec le numéro de séquence correct pour le chauffeur.
2.  **(agent):** Confirme que les PDF de facture et de bon de commande sont bien générés.
1.  **(agent):** Confirme via une capture d'écran que la modale de modification de course côté client fonctionne comme prévu.

**Project Health Check:**
- **Broken:** Aucun.
- **Mocked:** Aucun.

**3rd Party Integrations**
- **Resend:** Pour l'envoi d'emails transactionnels.
- **Stripe:** Pour la gestion des paiements et des commissions.
- **Google Maps API:** Pour le calcul d'itinéraires et l'autocomplétion d'adresses.

**Testing status**
  - Testing agent used after significant changes: YES
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: ['/app/test_reports/iteration_1.json']
  - Known regressions: Aucune.

**Credentials to test flow:**
- **Admin:**  / 
- **Driver:**  /  (ou créer un nouveau chauffeur)

**What agent forgot to execute**
- L'agent a consciemment mis de côté le problème de l'icône PWA (reporté du fork précédent) pour se concentrer sur la demande de refonte de la facturation, qui était une priorité beaucoup plus élevée pour l'utilisateur.</analysis>
